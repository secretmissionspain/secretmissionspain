<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pax Hispanica - Calculador de Batallas Terrestres</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .content {
            padding: 30px;
        }

        .form-section {
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            border-left: 5px solid #c41e3a;
        }

        .form-section h2 {
            color: #c41e3a;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        select, input[type="number"], input[type="radio"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #c41e3a;
        }

        .radio-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-option input[type="radio"] {
            width: auto;
        }

        .fleet-ships {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .ship {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .ship h4 {
            color: #c41e3a;
            margin-bottom: 10px;
        }

        .countries-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .country-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .country-card h3 {
            color: #c41e3a;
            margin-bottom: 15px;
            text-transform: capitalize;
        }

        .spaces-section {
            margin-top: 20px;
        }

        .space-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            margin-bottom: 20px;
        }

        .space-card h3 {
            color: #c41e3a;
            margin-bottom: 15px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        button {
            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(196, 30, 58, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(196, 30, 58, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .success-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .battle-result {
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 10px;
            border-left: 5px solid #28a745;
        }

        .result-section {
            margin-bottom: 25px;
        }

        .result-section h3 {
            color: #28a745;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .force-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .force-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .force-card h4 {
            color: #c41e3a;
            margin-bottom: 10px;
        }

        .winner {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
            color: #333;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
            }

            h1 {
                font-size: 2rem;
            }

            .content {
                padding: 20px;
            }

            .form-section {
                padding: 20px;
            }

            .fleet-ships {
                grid-template-columns: 1fr;
            }

            .countries-section {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Pax Hispanica</h1>
            <p>Calculador de Batallas Terrestres</p>
        </header>

        <div class="content">
            <div id="setup-phase">
                <div class="form-section">
                    <h2>Configuración de Batalla</h2>
                    <div class="form-group">
                        <label>¿La batalla se produce en tiempo de guerra?</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="war-yes" name="war" value="true">
                                <label for="war-yes">Sí</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="war-no" name="war" value="false">
                                <label for="war-no">No</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>Países y Jugadores</h2>
                    <div class="countries-section" id="countries-section">
                        <!-- Se generará dinámicamente -->
                    </div>
                </div>

                <div class="form-section">
                    <h2>Flota Atacante</h2>
                    <div class="form-group">
                        <label for="fleet-country">País de la flota:</label>
                        <select id="fleet-country">
                            <option value="">Seleccionar país</option>
                            <option value="españa">España</option>
                            <option value="francia">Francia</option>
                            <option value="holanda">Holanda</option>
                            <option value="curlandia">Curlandia</option>
                            <option value="inglaterra">Inglaterra</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fleet-legality">Legalidad:</label>
                        <select id="fleet-legality">
                            <option value="">Seleccionar legalidad</option>
                            <option value="corsario">Corsario</option>
                            <option value="saqueador">Saqueador</option>
                            <option value="contrabandista">Contrabandista</option>
                            <option value="conquistador">Conquistador</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fleet-ships-count">Número de barcos (1-3):</label>
                        <input type="number" id="fleet-ships-count" min="1" max="3" value="1">
                    </div>
                    <div class="fleet-ships" id="fleet-ships">
                        <!-- Se generará dinámicamente -->
                    </div>
                </div>

                <div class="form-section">
                    <h2>Espacios</h2>
                    <div class="spaces-section" id="spaces-section">
                        <!-- Se generará dinámicamente -->
                    </div>
                    <div class="button-group">
                        <button type="button" onclick="addSpace()">Añadir Espacio</button>
                    </div>
                </div>

                <div class="button-group">
                    <button type="button" onclick="generateBattle()">Generar Batalla</button>
                </div>

                <div id="error-container"></div>
            </div>

            <div id="battle-phase" class="hidden">
                <div class="battle-result">
                    <h2>Resultado de la Batalla</h2>
                    <div id="battle-result-content">
                        <!-- Se generará dinámicamente -->
                    </div>
                    <div class="button-group">
                        <button type="button" onclick="resetBattle()">Nueva Batalla</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let battleData = {};
        let spacesCount = 1;
        let activePlayerDecisions = {};

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            initializeCountries();
            initializeFleetShips();
            addSpace(); // Agregar el espacio objetivo inicial
        });

        // Inicializar países
        function initializeCountries() {
            const countries = ['españa', 'francia', 'holanda', 'curlandia', 'inglaterra'];
            const container = document.getElementById('countries-section');
            
            countries.forEach(country => {
                const countryCard = document.createElement('div');
                countryCard.className = 'country-card';
                countryCard.innerHTML = `
                    <h3>${country}</h3>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="${country}-active" name="${country}-player" value="true">
                            <label for="${country}-active">Jugador Activo</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="${country}-inactive" name="${country}-player" value="false">
                            <label for="${country}-inactive">No Activo</label>
                        </div>
                    </div>
                `;
                container.appendChild(countryCard);
            });
        }

        // Inicializar barcos de la flota
        function initializeFleetShips() {
            updateFleetShips();
            document.getElementById('fleet-ships-count').addEventListener('change', updateFleetShips);
        }

        function updateFleetShips() {
            const count = parseInt(document.getElementById('fleet-ships-count').value);
            const container = document.getElementById('fleet-ships');
            container.innerHTML = '';

            for (let i = 1; i <= count; i++) {
                const shipDiv = document.createElement('div');
                shipDiv.className = 'ship';
                shipDiv.innerHTML = `
                    <h4>Barco ${i}</h4>
                    <div class="form-group">
                        <label for="ship-${i}-cargo">Carga:</label>
                        <select id="ship-${i}-cargo">
                            <option value="vacio">Vacío</option>
                            <option value="botin">Botín</option>
                            <option value="ciudadano">Ciudadano</option>
                            <option value="esclavo">Esclavo</option>
                        </select>
                    </div>
                `;
                container.appendChild(shipDiv);
            }
        }

        // Agregar espacio
        function addSpace() {
            const container = document.getElementById('spaces-section');
            const spaceDiv = document.createElement('div');
            spaceDiv.className = 'space-card';
            spaceDiv.id = `space-${spacesCount}`;
            
            const isObjective = spacesCount === 1;
            const title = isObjective ? 'Espacio Objetivo' : `Espacio Adicional ${spacesCount - 1}`;
            
            spaceDiv.innerHTML = `
                <h3>${title}</h3>
                <div class="form-group">
                    <label for="space-${spacesCount}-type">Tipo:</label>
                    <select id="space-${spacesCount}-type" onchange="updateSpaceFields(${spacesCount})">
                        <option value="">Seleccionar tipo</option>
                        <option value="colonia">Colonia</option>
                        <option value="parroquia">Parroquia</option>
                        <option value="catedral">Catedral</option>
                        <option value="revuelta">Revuelta</option>
                        
                    </select>
                </div>
                <div id="space-${spacesCount}-fields"></div>
                ${!isObjective ? `<button type="button" onclick="removeSpace(${spacesCount})">Eliminar Espacio</button>` : ''}
            `;
            
            container.appendChild(spaceDiv);
            spacesCount++;
        }

        function removeSpace(spaceId) {
            const space = document.getElementById(`space-${spaceId}`);
            space.remove();
        }

        function updateSpaceFields(spaceId) {
            const type = document.getElementById(`space-${spaceId}-type`).value;
            const container = document.getElementById(`space-${spaceId}-fields`);
            container.innerHTML = '';

            if (type === 'colonia') {
                container.innerHTML = `
                    <div class="form-group">
                        <label for="space-${spaceId}-country">País:</label>
                        <select id="space-${spaceId}-country">
                            <option value="">Seleccionar país</option>
                            <option value="españa">España</option>
                            <option value="francia">Francia</option>
                            <option value="holanda">Holanda</option>
                            <option value="curlandia">Curlandia</option>
                            <option value="inglaterra">Inglaterra</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>¿Fortificada?</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="space-${spaceId}-fortified-yes" name="space-${spaceId}-fortified" value="true">
                                <label for="space-${spaceId}-fortified-yes">Sí</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="space-${spaceId}-fortified-no" name="space-${spaceId}-fortified" value="false">
                                <label for="space-${spaceId}-fortified-no">No</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="space-${spaceId}-inhabitant">Habitante:</label>
                        <select id="space-${spaceId}-inhabitant" onchange="updateInhabitantFields(${spaceId})">
                            <option value="">Sin habitante</option>
                            <option value="ciudadano">Ciudadano</option>
                            <option value="expatriado">Expatriado</option>
                            <option value="esclavo">Esclavo</option>
                        </select>
                    </div>
                    <div id="space-${spaceId}-inhabitant-fields"></div>
                `;
            } else if (type === 'parroquia') {
                container.innerHTML = `
                    <div class="form-group">
                        <label for="space-${spaceId}-country">País:</label>
                        <select id="space-${spaceId}-country">
                            <option value="">Seleccionar país</option>
                            <option value="españa">España</option>
                            <option value="francia">Francia</option>
                            <option value="holanda">Holanda</option>
                            <option value="curlandia">Curlandia</option>
                            <option value="inglaterra">Inglaterra</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>¿Tiene indígena?</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="space-${spaceId}-indigenous-yes" name="space-${spaceId}-indigenous" value="true">
                                <label for="space-${spaceId}-indigenous-yes">Sí</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="space-${spaceId}-indigenous-no" name="space-${spaceId}-indigenous" value="false">
                                <label for="space-${spaceId}-indigenous-no">No</label>
                            </div>
                        </div>
                    </div>
                `;
            } else if (type === 'catedral') {
                container.innerHTML = `
                    <div class="form-group">
                        <label for="space-${spaceId}-country">País:</label>
                        <select id="space-${spaceId}-country">
                            <option value="">Seleccionar país</option>
                            <option value="españa">España</option>
                            <option value="francia">Francia</option>
                            <option value="holanda">Holanda</option>
                            <option value="curlandia">Curlandia</option>
                            <option value="inglaterra">Inglaterra</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="space-${spaceId}-inhabitant">Habitante:</label>
                        <select id="space-${spaceId}-inhabitant" onchange="updateInhabitantFields(${spaceId})">
                            <option value="">Sin habitante</option>
                            <option value="ciudadano">Ciudadano</option>
                            <option value="expatriado">Expatriado</option>
                        </select>
                    </div>
                    <div id="space-${spaceId}-inhabitant-fields"></div>
                `;
            } else if (type === 'revuelta') {
                container.innerHTML = `
                    <div class="form-group">
                        <label for="space-${spaceId}-revolt-type">Tipo de revuelta:</label>
                        <select id="space-${spaceId}-revolt-type">
                            <option value="">Seleccionar tipo</option>
                            <option value="esclavos">Esclavos</option>
                            <option value="fiscal">Fiscal</option>
                        </select>
                    </div>
                `;
            } else if (type === 'flota') {
                container.innerHTML = `
                    <p><strong>Nota:</strong> Este espacio representa la posición de la flota atacante.</p>
                `;
            }
        }

        function updateInhabitantFields(spaceId) {
            const inhabitant = document.getElementById(`space-${spaceId}-inhabitant`).value;
            const container = document.getElementById(`space-${spaceId}-inhabitant-fields`);
            container.innerHTML = '';

            if (inhabitant === 'expatriado') {
                container.innerHTML = `
                    <div class="form-group">
                        <label for="space-${spaceId}-expatriate-country">País del expatriado:</label>
                        <select id="space-${spaceId}-expatriate-country">
                            <option value="">Seleccionar país</option>
                            <option value="españa">España</option>
                            <option value="francia">Francia</option>
                            <option value="holanda">Holanda</option>
                            <option value="curlandia">Curlandia</option>
                            <option value="inglaterra">Inglaterra</option>
                        </select>
                    </div>
                `;
            }
        }

        // Generar batalla
        function generateBattle() {
            try {
                battleData = collectBattleData();
                const validation = validateBattle(battleData);
                
                if (!validation.valid) {
                    showError(validation.error);
                    return;
                }

                // Cambiar a la fase de batalla
                document.getElementById('setup-phase').classList.add('hidden');
                document.getElementById('battle-phase').classList.remove('hidden');
                
                // Calcular y mostrar resultado
                calculateBattleResult(battleData);
                
            } catch (error) {
                showError('Error al generar la batalla: ' + error.message);
            }
        }

        // Recopilar datos de batalla
        function collectBattleData() {
            const data = {
                guerra: document.querySelector('input[name="war"]:checked')?.value === 'true',
                paises: {},
                flota: {},
                espacios: []
            };

            // Recopilar países
            const countries = ['españa', 'francia', 'holanda', 'curlandia', 'inglaterra'];
            countries.forEach(country => {
                const active = document.querySelector(`input[name="${country}-player"]:checked`)?.value === 'true';
                data.paises[country] = { jugadorActivo: active };
            });

            // Recopilar flota
            const fleetCountry = document.getElementById('fleet-country').value;
            const fleetLegality = document.getElementById('fleet-legality').value;
            const shipsCount = parseInt(document.getElementById('fleet-ships-count').value);
            
            const ships = [];
            for (let i = 1; i <= shipsCount; i++) {
                const cargo = document.getElementById(`ship-${i}-cargo`).value;
                ships.push({ carga: cargo });
            }

            data.flota = {
                pais: fleetCountry,
                legalidad: fleetLegality,
                barcos: ships,
                fuerzaDefensiva: shipsCount,
                fuerzaOfensiva: shipsCount
            };

            // Recopilar espacios
            for (let i = 1; i < spacesCount; i++) {
                const spaceElement = document.getElementById(`space-${i}`);
                if (!spaceElement) continue;
                
                const typeElement = document.getElementById(`space-${i}-type`);
                if (!typeElement) continue;
                
                const type = typeElement.value;
                if (!type) continue;

                const space = {
                    id: i,
                    tipo: type,
                    esObjetivo: i === 1
                };

                if (type === 'colonia') {
                    space.pais = document.getElementById(`space-${i}-country`).value;
                    space.fortificada = document.querySelector(`input[name="space-${i}-fortified"]:checked`)?.value === 'true';
                    space.habitante = document.getElementById(`space-${i}-inhabitant`).value || null;
                    
                    if (space.habitante === 'expatriado') {
                        space.paisExpatriado = document.getElementById(`space-${i}-expatriate-country`).value;
                    }
                    
                    // Calcular fuerzas
                    const baseFuerza = 1;
                    space.fuerzaDefensiva = baseFuerza + (space.fortificada ? 1 : 0);
                    space.fuerzaOfensiva = baseFuerza;
                    space.fuerzaCiudadano = space.habitante === 'ciudadano' ? 1 : 0;
                    space.fuerzaExpatriado = space.habitante === 'expatriado' ? 1 : 0;
                    
                } else if (type === 'parroquia') {
                    space.pais = document.getElementById(`space-${i}-country`).value;
                    space.indigena = document.querySelector(`input[name="space-${i}-indigenous"]:checked`)?.value === 'true';
                    
                    const fuerza = space.pais === 'francia' ? 1 : 0;
                    space.fuerzaDefensiva = fuerza;
                    space.fuerzaOfensiva = fuerza;
                    
                } else if (type === 'catedral') {
                    space.pais = document.getElementById(`space-${i}-country`).value;
                    space.habitante = document.getElementById(`space-${i}-inhabitant`).value || null;
                    
                    if (space.habitante === 'expatriado') {
                        space.paisExpatriado = document.getElementById(`space-${i}-expatriate-country`).value;
                    }
                    
                    const fuerza = space.pais === 'francia' ? 1 : 0;
                    space.fuerzaDefensiva = fuerza;
                    space.fuerzaOfensiva = fuerza;
                    space.fuerzaCiudadano = space.habitante === 'ciudadano' ? 1 : 0;
                    space.fuerzaExpatriado = space.habitante === 'expatriado' ? 1 : 0;
                    
                } else if (type === 'revuelta') {
                    space.tipoRevuelta = document.getElementById(`space-${i}-revolt-type`).value;
                    space.fuerza = 1;
                    
                } else if (type === 'flota') {
                    // Espacio de flota, no necesita campos adicionales
                }

                data.espacios.push(space);
            }

            return data;
        }

        // Validar batalla
        function validateBattle(data) {
            // Verificar que tenemos los datos básicos
            if (!data.flota.pais) {
                return { valid: false, error: 'Debe seleccionar el país de la flota' };
            }
            
            if (!data.flota.legalidad) {
                return { valid: false, error: 'Debe seleccionar la legalidad de la flota' };
            }

            // Verificar que hay al menos un espacio objetivo
            const objetivo = data.espacios.find(space => space.esObjetivo);
            if (!objetivo) {
                return { valid: false, error: 'Debe definir un espacio objetivo' };
            }

            // Verificar que la flota no ataca a su propio país
            if (objetivo.pais === data.flota.pais) {
                return { valid: false, error: 'La flota no puede atacar espacios de su propio país' };
            }

            // Verificar expatriado del mismo país
            if (objetivo.habitante === 'expatriado' && objetivo.paisExpatriado === data.flota.pais) {
                return { valid: false, error: 'La flota no puede atacar espacios ocupados por expatriados de su propio país' };
            }

            // Verificar legalidades
            const tipoAtaque = (objetivo.tipo === 'parroquia') ? 'esclavizacion' : 'ataque';
            
            if (data.flota.legalidad === 'contrabandista' && tipoAtaque === 'ataque') {
                return { valid: false, error: 'Los contrabandistas no pueden realizar ataques, solo esclavización' };
            }

            if (data.flota.legalidad === 'conquistador' && objetivo.pais === 'españa') {
                return { valid: false, error: 'Los conquistadores no pueden atacar espacios españoles' };
            }

            if (data.flota.legalidad === 'corsario' && tipoAtaque === 'ataque' && !data.guerra) {
                return { valid: false, error: 'Los corsarios solo pueden atacar en tiempo de guerra' };
            }

            // Verificar que hay colonia vacía para esclavización
            if (tipoAtaque === 'esclavizacion') {
                const coloniaVacia = data.espacios.find(space => 
                    space.tipo === 'colonia' && !space.habitante
                );
                if (!coloniaVacia) {
                    return { valid: false, error: 'Para esclavizar es necesario que haya una colonia vacía en el mapa' };
                }
            }

            return { valid: true };
        }

        // Calcular resultado de batalla
        function calculateBattleResult(data) {
            const resultado = {
                fuerzasFlota: {},
                fuerzasObjetivo: {},
                totalFlota: 0,
                totalObjetivo: 0,
                ganador: '',
                decisiones: []
            };

            const objetivo = data.espacios.find(space => space.esObjetivo);
            const paisFlota = data.flota.pais;
            const paisObjetivo = objetivo.pais;
            const expatriadoObjetivo = objetivo.habitante === 'expatriado' ? objetivo.paisExpatriado : null;

            // Inicializar fuerzas por país
            const countries = ['españa', 'francia', 'holanda', 'curlandia', 'inglaterra'];
            countries.forEach(country => {
                resultado.fuerzasFlota[country] = [];
                resultado.fuerzasObjetivo[country] = [];
            });
            resultado.fuerzasFlota.revueltas = [];
            resultado.fuerzasObjetivo.revueltas = [];

            // Procesar cada espacio
            data.espacios.forEach(space => {
                if (space.tipo === 'flota') return;




                if (space.tipo === 'revuelta') {
                    if (space.esObjetivo) {
                        // La revuelta es objetivo, apoya a la defensa
                        resultado.fuerzasObjetivo.revueltas.push({
                            descripcion: `Revuelta de ${space.tipoRevuelta}`,
                            fuerza: space.fuerza
                        });
                        resultado.totalObjetivo += space.fuerza;
                    } else {
                        // Las revueltas que NO son objetivo apoyan a la flota
                        resultado.fuerzasFlota.revueltas.push({
                            descripcion: `Revuelta de ${space.tipoRevuelta}`,
                            fuerza: space.fuerza
                        });
                        resultado.totalFlota += space.fuerza;
                    }
                } else {
                    // Separar fuerza del espacio y del expatriado
                    const paisEspacio = space.pais;
                    
                    // Calcular fuerza base del espacio (sin expatriado)
                    let fuerzaEspacio = 0;
                    let descripcionEspacio = '';

                    if (space.tipo === 'colonia') {
                        if (space.esObjetivo) {
                            //fuerzaEspacio = space.fuerzaDefensiva - (space.habitante === 'expatriado' ? space.fuerzaExpatriado : 0);
                            fuerzaEspacio = space.fuerzaDefensiva;
                            // Añadir "fortificada" a la descripción si corresponde
                            descripcionEspacio = space.fortificada ? `Colonia fortificada ${paisEspacio} (objetivo)` : `Colonia ${paisEspacio} (objetivo)`;
                            //descripcionEspacio = `Colonia ${paisEspacio} (objetivo)`;
                        } else {
                            fuerzaEspacio = space.fuerzaOfensiva;
                            descripcionEspacio = `Colonia ${paisEspacio}`;
                        }
                        
                        if (space.habitante === 'ciudadano') {
                            fuerzaEspacio += space.fuerzaCiudadano;
                            descripcionEspacio += ' con ciudadano';
                        }
                    } else if (space.tipo === 'parroquia') {
                        fuerzaEspacio = space.fuerzaDefensiva;
                        descripcionEspacio = `Parroquia ${paisEspacio}`;
                    } else if (space.tipo === 'catedral') {
                        //fuerzaEspacio = space.fuerzaDefensiva - (space.habitante === 'expatriado' ? space.fuerzaExpatriado : 0);
                        fuerzaEspacio = space.fuerzaDefensiva;
                        descripcionEspacio = `Catedral ${paisEspacio}`;
                        
                        if (space.habitante === 'ciudadano') {
                            fuerzaEspacio += space.fuerzaCiudadano;
                            descripcionEspacio += ' con ciudadano';
                        }
                    }

                    // Determinar apoyo del espacio
                    let apoyaFlota = false;
                    let apoyaObjetivo = false;
                    
                    if (paisEspacio === paisFlota) {
                        apoyaFlota = true;
                    } else if (paisEspacio === paisObjetivo) {
                        apoyaObjetivo = true;
                    } else if (expatriadoObjetivo && paisEspacio === expatriadoObjetivo) {
                        apoyaObjetivo = true;
                    } else if (!data.paises[paisEspacio].jugadorActivo) {
                        apoyaObjetivo = true;
                    } else {
                        // Jugador activo debe decidir
                        let decision = resultado.decisiones.find(d => d.pais === paisEspacio);
                        if (!decision) {
                            decision = { pais: paisEspacio, espacios: [] };
                            resultado.decisiones.push(decision);
                        }
                        decision.espacios.push({
                            descripcion: descripcionEspacio,
                            fuerza: fuerzaEspacio,
                            spaceId: space.id,
                            tipo: 'espacio'
                        });
                    }

                    // Asignar fuerza del espacio
                    if (apoyaFlota) {
                        resultado.fuerzasFlota[paisEspacio].push({
                            descripcion: descripcionEspacio,
                            fuerza: fuerzaEspacio
                        });
                        resultado.totalFlota += fuerzaEspacio;
                    } else if (apoyaObjetivo) {
                        resultado.fuerzasObjetivo[paisEspacio].push({
                            descripcion: descripcionEspacio,
                            fuerza: fuerzaEspacio
                        });
                        resultado.totalObjetivo += fuerzaEspacio;
                    }

                    // Procesar expatriado por separado
                    if (space.habitante === 'expatriado' && space.paisExpatriado) {
                        const paisExpatriado = space.paisExpatriado;
                        const fuerzaExpatriado = space.fuerzaExpatriado;
                        const descripcionExpatriado = `Expatriado de ${space.tipo} ${paisEspacio}`;

                        // Determinar apoyo del expatriado
                        let expatriadoApoyaFlota = false;
                        let expatriadoApoyaObjetivo = false;

                        if (paisExpatriado === paisFlota) {
                            expatriadoApoyaFlota = true;
                        } else if (paisExpatriado === paisObjetivo) {
                            expatriadoApoyaObjetivo = true;
                        } else if (expatriadoObjetivo && paisExpatriado === expatriadoObjetivo) {
                            expatriadoApoyaObjetivo = true;
                        } else if (!data.paises[paisExpatriado].jugadorActivo) {
                            expatriadoApoyaObjetivo = true;
                        } else {
                            // Jugador activo del país del expatriado debe decidir
                            let decision = resultado.decisiones.find(d => d.pais === paisExpatriado);
                            if (!decision) {
                                decision = { pais: paisExpatriado, espacios: [] };
                                resultado.decisiones.push(decision);
                            }
                            decision.espacios.push({
                                descripcion: descripcionExpatriado,
                                fuerza: fuerzaExpatriado,
                                spaceId: space.id,
                                tipo: 'expatriado'
                            });
                        }

                        // Asignar fuerza del expatriado
                        if (expatriadoApoyaFlota) {
                            resultado.fuerzasFlota[paisExpatriado].push({
                                descripcion: descripcionExpatriado,
                                fuerza: fuerzaExpatriado
                            });
                            resultado.totalFlota += fuerzaExpatriado;
                        } else if (expatriadoApoyaObjetivo) {
                            resultado.fuerzasObjetivo[paisExpatriado].push({
                                descripcion: descripcionExpatriado,
                                fuerza: fuerzaExpatriado
                            });
                            resultado.totalObjetivo += fuerzaExpatriado;
                        }
                    }
                }
            });

            // Agregar fuerza de la flota
            resultado.fuerzasFlota[paisFlota].push({
                descripcion: `Flota ${paisFlota} (${data.flota.barcos.length} barcos)`,
                fuerza: data.flota.fuerzaOfensiva
            });
            resultado.totalFlota += data.flota.fuerzaOfensiva;

            // Determinar ganador si no hay decisiones pendientes
            if (resultado.decisiones.length === 0) {
                resultado.ganador = resultado.totalFlota > resultado.totalObjetivo ? 'Flota' : 'Objetivo';
            }

            displayBattleResult(resultado, data);
        }

        // Mostrar resultado de batalla
        function displayBattleResult(resultado, data) {
            const container = document.getElementById('battle-result-content');
            let html = '';

            // Mostrar JSON de datos
            html += `
                <div class="result-section">
                    <button onclick="toggleDatosBatalla()" 
                            style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                        <span id="toggle-text">Mostrar Datos de la Batalla</span>
                    </button>
                    <div id="datos-batalla-content" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.9rem; overflow-x: auto; margin-top: 10px;">
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                </div>
                <script>
                    function toggleDatosBatalla() {
                        const content = document.getElementById('datos-batalla-content');
                        const text = document.getElementById('toggle-text');
                        if (content.style.display === 'none') {
                            content.style.display = 'block';
                            text.textContent = 'Ocultar Datos de la Batalla';
                        } else {
                            content.style.display = 'none';
                            text.textContent = 'Mostrar Datos de la Batalla';
                        }
                    }
                </script>
            `;

            // Mostrar decisiones pendientes si las hay
            if (resultado.decisiones.length > 0) {
                html += `
                    <div class="result-section">
                        <h3>Decisiones de Jugadores Activos</h3>
                        <p>Los siguientes países deben decidir a quién apoyan:</p>
                `;
                
                resultado.decisiones.forEach(decision => {
                    html += `
                        <div class="force-card">
                            <h4>${decision.pais.toUpperCase()}</h4>
                            <p>Elementos que pueden apoyar:</p>
                            <ul>
                    `;
                    
                    decision.espacios.forEach(espacio => {
                        html += `<li>${espacio.descripcion} (Fuerza: ${espacio.fuerza})</li>`;
                    });
                    
                    html += `
                            </ul>
                            <div class="button-group">
                                <button onclick="makeDecision('${decision.pais}', 'flota')">Apoyar Flota</button>
                                <button onclick="makeDecision('${decision.pais}', 'objetivo')">Apoyar Objetivo</button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }

            // Mostrar fuerzas actuales
            html += `
                <div class="result-section">
                    <h3>Fuerzas en Combate</h3>
                    <div class="force-summary">
                        <div class="force-card">
                            <h4>Fuerzas de la Flota (Total: ${resultado.totalFlota})</h4>
            `;

            Object.keys(resultado.fuerzasFlota).forEach(pais => {
                if (resultado.fuerzasFlota[pais].length > 0) {
                    html += `<p><strong>${pais.toUpperCase()}:</strong></p><ul>`;
                    resultado.fuerzasFlota[pais].forEach(elemento => {
                        html += `<li>${elemento.descripcion} (${elemento.fuerza})</li>`;
                    });
                    html += '</ul>';
                }
            });

            html += `
                        </div>
                        <div class="force-card">
                            <h4>Fuerzas del Objetivo (Total: ${resultado.totalObjetivo})</h4>
            `;

            Object.keys(resultado.fuerzasObjetivo).forEach(pais => {
                if (resultado.fuerzasObjetivo[pais].length > 0) {
                    html += `<p><strong>${pais.toUpperCase()}:</strong></p><ul>`;
                    resultado.fuerzasObjetivo[pais].forEach(elemento => {
                        html += `<li>${elemento.descripcion} (${elemento.fuerza})</li>`;
                    });
                    html += '</ul>';
                }
            });

            html += '</div></div></div>';

            // Mostrar ganador si está determinado
            if (resultado.ganador) {
                html += `
                    <div class="winner">
                        🏆 Ganador: ${resultado.ganador}
                    </div>
                `;
            }

            container.innerHTML = html;
            
            // Guardar resultado para decisiones
            window.currentBattleResult = resultado;
            window.currentBattleData = data;
        }

        // Tomar decisión de jugador activo
        function makeDecision(pais, bando) {
            const resultado = window.currentBattleResult;
            const decision = resultado.decisiones.find(d => d.pais === pais);
            
            if (!decision) return;

            // Mover fuerzas al bando correspondiente
            decision.espacios.forEach(elemento => {
                if (bando === 'flota') {
                    resultado.fuerzasFlota[pais].push({
                        descripcion: elemento.descripcion,
                        fuerza: elemento.fuerza
                    });
                    resultado.totalFlota += elemento.fuerza;
                } else {
                    resultado.fuerzasObjetivo[pais].push({
                        descripcion: elemento.descripcion,
                        fuerza: elemento.fuerza
                    });
                    resultado.totalObjetivo += elemento.fuerza;
                }
            });

            // Eliminar decisión procesada
            resultado.decisiones = resultado.decisiones.filter(d => d.pais !== pais);

            // Determinar ganador si no quedan decisiones
            if (resultado.decisiones.length === 0) {
                resultado.ganador = resultado.totalFlota > resultado.totalObjetivo ? 'Flota' : 'Objetivo';
            }

            // Actualizar vista
            displayBattleResult(resultado, window.currentBattleData);
        }

        // Mostrar error
        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `
                <div class="error-message">
                    <strong>Error:</strong> ${message}
                </div>
            `;
            
            // Scroll al error
            container.scrollIntoView({ behavior: 'smooth' });
        }

        // Reiniciar batalla
        function resetBattle() {
            document.getElementById('setup-phase').classList.remove('hidden');
            document.getElementById('battle-phase').classList.add('hidden');
            document.getElementById('error-container').innerHTML = '';
            
            // Limpiar datos
            battleData = {};
            activePlayerDecisions = {};
            window.currentBattleResult = null;
            window.currentBattleData = null;
        }
    </script>
</body>
</html>
